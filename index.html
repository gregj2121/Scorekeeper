<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Play Nine Scorecard</title>

  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; padding:10px; }
    h1,h2 { text-align:center; }

    #tabs { display:flex; justify-content:center; margin-bottom:10px; }
    #tabs button { padding:8px 12px; margin:0 5px; font-size:14px; }
    .active-tab { font-weight:bold; background:#ddd; }

    #controls { text-align:center; margin-bottom:10px; }
    input, button { font-size:14px; padding:6px; margin:2px; }

    .table-wrapper { overflow-x:auto; }
    table { width:auto; border-collapse:collapse; background:white; margin-bottom:15px; }
    th, td { border:1px solid #ddd; padding:6px 10px; text-align:center; white-space:nowrap; }
    th { background:#eee; }

    td input { width:55px; text-align:center; }
    .total-row { font-weight:bold; background:#fafafa; }
    .leader { background:#d9edf7; }

    .player-header { display:inline-flex; align-items:center; gap:4px; }
    .player-header button { font-size:12px; padding:2px 5px; }

    .danger { color:red; }
    .muted { color:#666; text-align:center; }
  </style>
</head>
<body>

<h1>Play Nine Scorecard</h1>

<div id="tabs">
  <button id="scoreTab" class="active-tab">Scorecard</button>
  <button id="historyTab">History</button>
</div>

<!-- SCORECARD -->
<div id="scorecardView">
  <div id="controls">
    <input id="playerName" placeholder="Player name" />
    <button id="addPlayerBtn">Add Player</button>
    <button id="endGameBtn">End Game</button>
    <button id="resetScoresBtn">Reset Scores</button>
  </div>

  <div class="table-wrapper" id="tableContainer"></div>
  <div id="ranking"></div>
</div>

<!-- HISTORY -->
<div id="historyView" style="display:none"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, deleteDoc, doc,
    query, orderBy, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyANco7Z5TrnOEeXrReubwTxFlIsw1Sr0Ck",
    authDomain: "play-nine-scorecard-f56ad.firebaseapp.com",
    projectId: "play-nine-scorecard-f56ad",
    storageBucket: "play-nine-scorecard-f56ad.firebasestorage.app",
    messagingSenderId: "716365636842",
    appId: "1:716365636842:web:4be3bfad6121da3abbe393",
    measurementId: "G-XQS2D4H84E"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const ROUNDS = 9;

  let local = JSON.parse(localStorage.getItem("playNineLocal")) || {
    players: [],
    scores: []
  };

  let history = []; // shared from Firestore

  function saveLocal() {
    localStorage.setItem("playNineLocal", JSON.stringify(local));
  }

  // --------- Tabs ----------
  const scorecardView = document.getElementById("scorecardView");
  const historyView = document.getElementById("historyView");
  const scoreTab = document.getElementById("scoreTab");
  const historyTab = document.getElementById("historyTab");

  scoreTab.onclick = () => showScorecard();
  historyTab.onclick = () => showHistory();

  function showScorecard() {
    scorecardView.style.display = "block";
    historyView.style.display = "none";
    scoreTab.classList.add("active-tab");
    historyTab.classList.remove("active-tab");
  }

  async function showHistory() {
    scorecardView.style.display = "none";
    historyView.style.display = "block";
    historyTab.classList.add("active-tab");
    scoreTab.classList.remove("active-tab");
    await loadHistoryFromCloud();
    renderHistory();
  }

  // --------- Scorecard logic ----------
  document.getElementById("addPlayerBtn").onclick = addPlayer;
  document.getElementById("endGameBtn").onclick = endGame;
  document.getElementById("resetScoresBtn").onclick = resetScores;

  function addPlayer() {
    const input = document.getElementById("playerName");
    const name = input.value.trim();
    if (!name) return;

    local.players.push(name);
    local.scores.push(Array(ROUNDS).fill(null));

    input.value = "";
    saveLocal();
    renderScorecard();
  }

  function renamePlayer(i) {
    const name = prompt("Rename player:", local.players[i]);
    if (!name) return;

    local.players[i] = name.trim();
    saveLocal();
    renderScorecard();
  }

  function deletePlayer(i) {
    if (!confirm("Delete this player and all current scores?")) return;

    local.players.splice(i, 1);
    local.scores.splice(i, 1);
    saveLocal();
    renderScorecard();
  }

  function updateScore(p, r, value) {
    local.scores[p][r] = value === "" ? null : Number(value);
    saveLocal();
    renderScorecard();
  }

  function getTotal(i) {
    return local.scores[i]
      .filter(v => v !== null)
      .reduce((a, b) => a + b, 0);
  }

  // Lowest total wins
  function getLeaders() {
    const totals = local.players.map((_, i) => getTotal(i));
    const min = Math.min(...totals);
    return totals.map(t => t === min);
  }

  function resetScores() {
    if (!confirm("Clear current scores?")) return;
    local.scores = local.players.map(() => Array(ROUNDS).fill(null));
    saveLocal();
    renderScorecard();
  }

  function renderCurrentRanking() {
    const ranking = local.players
      .map((name, i) => ({ name, total: getTotal(i) }))
      .sort((a, b) => a.total - b.total);

    return `
      <h2>Current Rankings</h2>
      <table>
        <tr><th>Position</th><th>Player</th><th>Total</th></tr>
        ${ranking.map((p, i) =>
          `<tr><td>${i + 1}</td><td>${escapeHtml(p.name)}</td><td>${p.total}</td></tr>`
        ).join("")}
      </table>
    `;
  }

  function renderScorecard() {
    const table = document.getElementById("tableContainer");
    const rankingDiv = document.getElementById("ranking");

    if (!local.players.length) {
      table.innerHTML = "<p class='muted'>Add players to begin</p>";
      rankingDiv.innerHTML = "";
      return;
    }

    const leaders = getLeaders();

    let html = "<table><tr><th>Round</th>";
    local.players.forEach((p, i) => {
      html += `
        <th class="${leaders[i] ? "leader" : ""}">
          <span class="player-header">
            ${escapeHtml(p)}
            <button onclick="window._renamePlayer(${i})">‚úèÔ∏è</button>
            <button onclick="window._deletePlayer(${i})">üóë</button>
          </span>
        </th>`;
    });
    html += "</tr>";

    for (let r = 0; r < ROUNDS; r++) {
      html += `<tr><td>Round ${r + 1}</td>`;
      local.players.forEach((_, p) => {
        html += `
          <td class="${leaders[p] ? "leader" : ""}">
            <input type="number"
                   value="${local.scores[p][r] ?? ""}"
                   onchange="window._updateScore(${p}, ${r}, this.value)">
          </td>`;
      });
      html += "</tr>";
    }

    html += `<tr class="total-row"><td>Total</td>`;
    local.players.forEach((_, i) => {
      html += `<td class="${leaders[i] ? "leader" : ""}">${getTotal(i)}</td>`;
    });
    html += "</tr></table>";

    table.innerHTML = html;
    rankingDiv.innerHTML = renderCurrentRanking();
  }

  window._renamePlayer = renamePlayer;
  window._deletePlayer = deletePlayer;
  window._updateScore = updateScore;

  // --------- Firestore (shared history) ----------
  async function loadHistoryFromCloud() {
    const q = query(collection(db, "games"), orderBy("createdAt", "desc"));
    const snap = await getDocs(q);
    history = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  }

  async function saveGameToCloud(game) {
    await addDoc(collection(db, "games"), game);
  }

  async function deleteGameFromCloud(gameId) {
    await deleteDoc(doc(db, "games", gameId));
  }

  async function endGame() {
    if (!local.players.length) return;
    if (!confirm("End game and save results to shared history?")) return;

    const totals = local.players.map((name, i) => ({ name, total: getTotal(i) }));
    const min = Math.min(...totals.map(t => t.total));
    const winners = totals.filter(t => t.total === min).map(t => t.name);

    const game = {
      createdAt: serverTimestamp(),
      dateLabel: new Date().toLocaleString(),
      winners,
      totals
    };

    await saveGameToCloud(game);

    // Next game locally
    local.scores = local.players.map(() => Array(ROUNDS).fill(null));
    saveLocal();
    renderScorecard();
  }

  async function deleteGame(index) {
    const g = history[index];
    if (!g?.id) return;
    if (!confirm("Delete this game from shared history?")) return;

    await deleteGameFromCloud(g.id);
    await loadHistoryFromCloud();
    renderHistory();
  }

  window._deleteGame = deleteGame;

  // --------- History rendering ----------
  function renderAllTimeLeaderboard() {
    const stats = {};

    history.forEach(g => {
      const winners = new Set(g.winners || []);
      (g.totals || []).forEach(t => {
        const name = t.name;
        const score = Number(t.total) || 0;

        if (!stats[name]) {
          stats[name] = {
            name,
            games: 0,
            wins: 0,
            totalScore: 0,
            best: null,  // lowest score (best in Play Nine)
            worst: null  // highest score
          };
        }

        const s = stats[name];
        s.games++;
        s.totalScore += score;
        if (winners.has(name)) s.wins++;

        s.best = (s.best === null) ? score : Math.min(s.best, score);
        s.worst = (s.worst === null) ? score : Math.max(s.worst, score);
      });
    });

    const rows = Object.values(stats).map(p => {
      const avg = p.games ? (p.totalScore / p.games) : 0;
      const winPct = p.games ? (p.wins / p.games) : 0;
      return { ...p, avg, winPct };
    })
    // Rank by wins desc, then win% desc, then avg asc (lower is better)
    .sort((a, b) =>
      (b.wins - a.wins) ||
      (b.winPct - a.winPct) ||
      (a.avg - b.avg)
    );

    if (!rows.length) return "<p class='muted'>No games yet.</p>";

    return `
      <h2>All-Time Leaderboard</h2>
      <div class="table-wrapper">
        <table>
          <tr>
            <th>Rank</th>
            <th>Player</th>
            <th>Wins</th>
            <th>Games</th>
            <th>Win %</th>
            <th>Avg</th>
            <th>Best</th>
            <th>Worst</th>
          </tr>
          ${rows.map((p, i) => `
            <tr>
              <td>${i + 1}</td>
              <td>${escapeHtml(p.name)}</td>
              <td>${p.wins}</td>
              <td>${p.games}</td>
              <td>${(p.winPct * 100).toFixed(0)}%</td>
              <td>${p.avg.toFixed(1)}</td>
              <td>${p.best ?? ""}</td>
              <td>${p.worst ?? ""}</td>
            </tr>
          `).join("")}
        </table>
      </div>
    `;
  }

  function renderHistory() {
    if (!history.length) {
      historyView.innerHTML = "<h2>No games played yet</h2>";
      return;
    }

    historyView.innerHTML = `
      ${renderAllTimeLeaderboard()}
      <h2>Game History</h2>
      <div class="table-wrapper">
        <table>
          <tr><th>Date</th><th>Winner(s)</th><th>Scores</th><th></th></tr>
          ${history.map((g, i) => `
            <tr>
              <td>${escapeHtml(g.dateLabel || "")}</td>
              <td>${escapeHtml((g.winners || []).join(", "))}</td>
              <td>${escapeHtml((g.totals || []).map(t => `${t.name}: ${t.total}`).join(" | "))}</td>
              <td><button class="danger" onclick="window._deleteGame(${i})">üóë</button></td>
            </tr>
          `).join("")}
        </table>
      </div>
      <p class="muted">History + leaderboard are shared (Firestore). Scorecard-in-progress stays on your device.</p>
    `;
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[s]));
  }

  // Initial render
  renderScorecard();
</script>

</body>
</html>
